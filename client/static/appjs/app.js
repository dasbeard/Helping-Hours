var app=angular.module("myApp",["ui.router","ui.bootstrap","ngCookies","ngSanitize","ngAnimate","ui.mask","ngMap","ngclipboard","ng-weekday-selector"]);app.config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("/",{url:"/",templateUrl:"../partials/home.html",controller:"homeController"}).state("logReg",{url:"/logReg",templateUrl:"../partials/logReg.html",controller:"logRegController"}).state("edit",{url:"/edit",templateUrl:"../partials/edit.html",controller:"editController"}).state("organization",{url:"/organization/:id",templateUrl:"../partials/organization.html",controller:"organizationController"}).state("admin",{url:"/admin",templateUrl:"../partials/adminPortal.html",controller:"logRegController as $lCtrl"}).state("adminHome",{url:"/adminHome",templateUrl:"../partials/adminHome.html",controller:"adminController as $ctrl"})}]),app.controller("adminController",["$scope","adminFactory","$location","$cookies","$window","$state","$uibModal",function($scope,adminFactory,$location,$cookies,$window,$state,$uibModal){function getAllAdmin(){adminFactory.getAllAdmin(function(output){$scope.allOrgs=output.data})}var $ctrl=this;$cookies.getObject("loggedAdmin")?($scope.loggedInAdmin=$cookies.getObject("loggedAdmin"),getAllAdmin()):window.location.replace("/"),$ctrl.open=function(orgId,orgName,size,parentSelector){$ctrl.orgToRemove={id:orgId,name:orgName};var parentElem=parentSelector?angular.element($document[0].querySelector(".Delete-Organization "+parentSelector)):void 0;$uibModal.open({ariaDescribedBy:"modal-body",templateUrl:"deleteOrgModal.html",controller:"deleteOrgCtrl",controllerAs:"$ctrl",appendTo:parentElem,resolve:{orgInfo:function(){return $ctrl.orgToRemove}}}).result.then(function(orgInfo){getAllAdmin()},function(){})},$ctrl.edit=function(orgId,orgName,email,phone,formattedAddress,size,parentSelector){$ctrl.orgToEdit={id:orgId,name:orgName,email:email,phone:phone,address:formattedAddress};var parentElem=parentSelector?angular.element($document[0].querySelector(".Edit-Organization "+parentSelector)):void 0;$uibModal.open({ariaDescribedBy:"modal-body",templateUrl:"editOrgModal.html",controller:"editOrgModalCtrl",controllerAs:"$ctrl",size:"sm",appendTo:parentElem,resolve:{orgInfo:function(){return $ctrl.orgToEdit}}}).result.then(function(orgInfo){getAllAdmin()},function(){})}}]),app.controller("deleteOrgCtrl",["$scope","$uibModalInstance","orgInfo","adminFactory",function($scope,$uibModalInstance,orgInfo,adminFactory){$scope.orgInfo=orgInfo,$scope.removeOrg=function(){adminFactory.deleteOrg(orgInfo,function(output){1==output.data?$uibModalInstance.close(orgInfo):$scope.error2=output.data})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),app.controller("editOrgModalCtrl",["$scope","$uibModalInstance","$scope","orgInfo","adminFactory",function($scope,$uibModalInstance,$scope,orgInfo,adminFactory){$scope.orgInfo=orgInfo,$scope.editOrgAdmin=function(isValid){isValid&&adminFactory.editOrgAdmin($scope.orgInfo,function(output){output.data.error?$scope.error2=output.data.error:1==output.data&&$uibModalInstance.close(orgInfo)})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),app.controller("editController",["$scope","editFactory","$location","$cookies","$window","$uibModal","$log","$document",function($scope,editFactory,$location,$cookies,$window,$uibModal,$log,$document){function getOrganizationInfo(){editFactory.getOrgInfo($scope.loggedInUser,function(output){output.data.error?(console.log("Error"),console.log(output.data.error),$scope.error=output.data.error):($scope.editOrg=output.data,$scope.editOrgServices=output.data.services,$scope.isAvailable={},output.data.contactEmail&&($scope.isAvailable.email=!0),output.data.website&&($scope.isAvailable.website=!0),output.data.phone&&($scope.isAvailable.phone=!0),$scope.loggedInUser=$cookies.getObject("loggedUser"))})}function clearError(){setTimeout(function(){$scope.$apply(function(){$scope.error=!1})},5e3)}$cookies.getObject("loggedUser")?($scope.loggedInUser=$cookies.getObject("loggedUser"),getOrganizationInfo()):window.location.replace("/"),$scope.editOrganization=function(isValid){var checkboxServices={};$scope.error="",$scope.editOrgServices?(1==$scope.editOrgServices.beds?checkboxServices.beds=!0:checkboxServices.beds=!1,1==$scope.editOrgServices.cloths?checkboxServices.cloths=!0:checkboxServices.cloths=!1,1==$scope.editOrgServices.education?checkboxServices.education=!0:checkboxServices.education=!1,1==$scope.editOrgServices.interview?checkboxServices.interview=!0:checkboxServices.interview=!1,1==$scope.editOrgServices.job?checkboxServices.job=!0:checkboxServices.job=!1,1==$scope.editOrgServices.childCare?checkboxServices.childCare=!0:checkboxServices.childCare=!1,1==$scope.editOrgServices.recActivites?checkboxServices.recActivites=!0:checkboxServices.recActivites=!1,1==$scope.editOrgServices.donations?checkboxServices.donations=!0:checkboxServices.donations=!1,$scope.editOrgServices.otherServices?checkboxServices.otherServices=$scope.editOrgServices.otherServices:checkboxServices.otherServices=""):(checkboxServices.beds=!1,checkboxServices.cloths=!1,checkboxServices.education=!1,checkboxServices.interview=!1,checkboxServices.job=!1,checkboxServices.childCare=!1,checkboxServices.recActivities=!1,checkboxServices.donations=!1,checkboxServices.otherServices="");var services={};$scope.editOrg.website&&(services.website=$scope.editOrg.website),$scope.editOrg.contactEmail&&(services.contactEmail=$scope.editOrg.contactEmail),$scope.editOrg.phone&&(services.phone=$scope.editOrg.phone),$scope.editOrg.description?services.description=$scope.editOrg.description:services.description="",services.checkboxes=checkboxServices,services.id=$scope.loggedInUser.id,editFactory.updateServices(services,function(output){output.data.error?($scope.error=output.data.error,clearError()):1==output.data&&(getOrganizationInfo(),$scope.savedMask=!0,setTimeout(function(){$scope.$apply(function(){$scope.savedMask=!1}),window.location.replace("/#!/organization/"+$scope.loggedInUser.id)},1e3))})},$scope.addDay2=function(input){var toSend={id:$scope.loggedInUser.id,input:input};$uibModal.open({ariaDescribedBy:"modal-body",templateUrl:"HoursOfOpModal.html",controller:"HoursOfOpCtrl",size:"lg",resolve:{typeOfDay:function(){return toSend}}}).result.then(function(response){getOrganizationInfo()},function(){})},$scope.removeDay=function(idx,service){var toRemove={id:$scope.loggedInUser.id,index:idx,service:service};editFactory.removeDay(toRemove,function(output){output.data.error?$scope.error=output.error:getOrganizationInfo()})}}]),app.controller("HoursOfOpCtrl",["$scope","$uibModalInstance","editFactory","typeOfDay",function($scope,$uibModalInstance,editFactory,typeOfDay){$scope.open="2017-10-26T07:00:43.000Z",$scope.close=$scope.open,$scope.modalTitle="HOP"==typeOfDay?"When are you Open?":"When are you Serving Food?",$scope.add=function(){var daysToAdd=[];for(i=0;i<$scope.days.length;i++)1==$scope.days[i].isSelected&&($scope.days[i].open=$scope.open,$scope.days[i].close=$scope.close,daysToAdd.push($scope.days[i]));var sendToDB={id:typeOfDay.id,type:typeOfDay.input,days:daysToAdd};editFactory.addDay(sendToDB,function(output){"error"==output.data?($scope.error=output.error,setTimeout(function(){$scope.$apply(function(){$scope.error=!1})},5e3)):$uibModalInstance.close(!0)})},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),app.controller("homeController",["$scope","homeFactory","$location","$cookies","$window","NgMap","$state","$timeout",function($scope,homeFactory,$location,$cookies,$window,NgMap,$state,$timeout){function getNearBy(pos){homeFactory.getNearBy(pos,function(output){output.error||($scope.within2miles=output.data.within2miles,$scope.within5miles=output.data.within5miles,$scope.within25miles=output.data.within25miles,$scope.loadingOrgs=!1)})}$scope.loadingOrgs=!0,function getAllOrgs(){homeFactory.findAllOrgs(function(output){vm.orgs=output.data,vm.org=vm.orgs[0]})}();var vm=this;NgMap.getMap({id:"mapId"}).then(function(map){function handleLocationError(browserHasGeolocation,infowindow,pos){map.setPosition(pos),map.setContent(browserHasGeolocation?"Error: The Geolocation service failed.":"Error: Your browser doesn't support geolocation.")}if(google.maps.event.trigger(map,"resize"),navigator.geolocation)if($cookies.getObject("currentUserPosition")){var pos=$cookies.getObject("currentUserPosition");new google.maps.Marker({position:pos,animation:google.maps.Animation.DROP,map:map,icon:"assets/locationPinSmall.png"});map.setCenter(pos),map.setZoom(12),getNearBy(pos)}else $cookies.getObject("currentUserPosition")?handleLocationError(!1,infowindow,map.getCenter()):navigator.geolocation.getCurrentPosition(function(position){var pos={lat:position.coords.latitude,lng:position.coords.longitude,zoom:8},today=new Date;today.setDate(today.getDate()+2),$cookies.putObject("currentUserPosition",pos,[today]);new google.maps.Marker({position:pos,animation:google.maps.Animation.DROP,map:map,icon:"assets/locationPinSmall.png"});map.setCenter(pos),map.setZoom(10),getNearBy(pos)},function(){handleLocationError(!0,infowindow,map.getCenter())});vm.map=map}),$scope.oneAtATime=!0,$scope.status={isFirstOpen:!0,isFirstDisabled:!1},$scope.visitOrg=function(orgId){$state.go("organization",{id:orgId})},vm.showDetail=function(e,org){vm.org=org,vm.map.showInfoWindow("orgInfoWindow",org.organization)},$scope.openWebsite=function(website){var site="http://";site+=website,$window.open(site)},$scope.openMap=function(position){var site="https://www.google.com/maps/dir/?api=1&destination=";site+=encodeURI(position),$window.open(site)},vm.goToOrg=function(orgId){$state.go("organization",{id:orgId})},$scope.goToOrgSearch=function(orgId){$state.go("organization",{id:orgId})},$scope.citySearch=function(){$scope.searchBy={city:$scope.city,state:$scope.state},$scope.noLocations="",$scope.searchedCity={},homeFactory.citySearch($scope.searchBy,function(output){output.data.error?$scope.noLocations="No Locations Found":$scope.searchedCity=output.data})},$scope.copyEmail=function(){$scope.copied=1,$timeout(function(){$scope.copied=0},2600)}}]),app.controller("organizationController",["$scope","editFactory","$location","$cookies","$window","NgMap","$stateParams","$timeout",function($scope,editFactory,$location,$cookies,$window,NgMap,$stateParams,$timeout){function phoneDisplay(str){return 10==str.length?"("+str.substr(0,3)+")"+str.substr(3,3)+"-"+str.substr(6):str.substr(0,1)+"("+str.substr(1,3)+")"+str.substr(4,3)+"-"+str.substr(7)}$scope.daysStatus=!1,$scope.noOrgInfo=!1,$scope.findOrg=$stateParams,($scope.loggedInUser=$cookies.getObject("loggedUser"))&&($scope.loggedInUser.id==$scope.findOrg.id?$scope.loggedOrg=!0:$scope.loggedOrg=!1),editFactory.getOrgInfo($scope.findOrg,function(output){output.data.error?(console.log("Error"),console.log(output.data.error)):($scope.org=output.data,$scope.orgServices=output.data.services,$scope.latLong=output.data.lat+","+output.data.lng,$scope.org.daysServingFood.length<1&&$scope.org.hoursOfOperation.length<1&&($scope.daysStatus=!0),$scope.org.contactEmail||$scope.org.phone||$scope.org.website||($scope.noOrgInfo=!0),output.data.phone&&($scope.org.phone=phoneDisplay(output.data.phone)),NgMap.getMap().then(function(map){new google.maps.Marker({position:{lat:$scope.org.lat,lng:$scope.org.lng},map:map,clickable:!1,animation:google.maps.Animation.DROP})}))}),$scope.copyEmail=function(){$scope.copied=1,$timeout(function(){$scope.copied=0},2800)},$scope.openWebsite=function(){var site="http://";site+=$scope.org.website,$window.open(site)},$scope.openMap=function(){var site="https://www.google.com/maps/dir/?api=1&destination=";site+=encodeURI($scope.org.formattedAddress),$window.open(site)}}]),app.controller("logRegController",["$scope","$rootScope","logRegFactory","adminFactory","$location","$cookies","$window","$state","$uibModal",function($scope,$rootScope,logRegFactory,adminFactory,$location,$cookies,$window,$state,$uibModal){function setCookie(input,admin){var expireAt=new Date;expireAt.setDate(expireAt.getDate()+.5),admin?($cookies.putObject("loggedAdmin",input,{expires:expireAt}),$rootScope.loggedInAdmin=$cookies.getObject("loggedAdmin")):($cookies.putObject("loggedUser",input,{expires:expireAt}),$rootScope.loggedInUser=$cookies.getObject("loggedUser"))}function orgModal(locationResponse,parentSelector){var parentElem=parentSelector?angular.element($document[0].querySelector(".Organization-Modal "+parentSelector)):void 0;$uibModal.open({ariaDescribedBy:"modal-body",templateUrl:"organizationModal.html",controller:"organizationCtrl",appendTo:parentElem,resolve:{location:function(){return locationResponse}}}).result.then(function(response){setCookie(response.sentback),window.location.replace("/#!/edit")},function(){})}function latLngModal(parentSelector,input){var parentElem=parentSelector?angular.element($document[0].querySelector(".LatLng-Modal "+parentSelector)):void 0;$uibModal.open({ariaDescribedBy:"modal-body",templateUrl:"latLngModal.html",controller:"LatLngCtrl",size:"lg",appendTo:parentElem,resolve:{}}).result.then(function(response){orgModal(response)},function(){})}function clearError(){setTimeout(function(){$scope.$apply(function(){$scope.error=!1})},5e3)}$cookies.getObject("loggedUser")&&($rootScope.loggedInUser=$cookies.getObject("loggedUser")),$cookies.getObject("loggedAdmin")&&($rootScope.loggedInAdmin=$cookies.getObject("loggedAdmin")),$scope.register=function(isValid,size,parentSelector){isValid?$scope.reg?$scope.reg.street?$scope.reg.city?$scope.reg.zip?($scope.error="",logRegFactory.findLocation($scope.reg,function(output){if(output.error)$scope.error=output.error;else{var allFound=output.data,parentElem=parentSelector?angular.element($document[0].querySelector(".Location-Modal "+parentSelector)):void 0;$uibModal.open({ariaDescribedBy:"modal-body",templateUrl:"yourLocationModal.html",controller:"yourLocationCtrl",size:size,appendTo:parentElem,resolve:{allFound:function(){return allFound}}}).result.then(function(locationResponse){if("LatLng"==locationResponse&&latLngModal(),locationResponse.formattedAddress)orgModal(locationResponse)},function(){})}})):$scope.error="Please enter a Zip code":$scope.error="Please enter the city of the organization to be registered":$scope.error="Please enter the street of the organization to be registered":$scope.error="Please enter your information to register":isValid||($scope.error="All fields are required to Register",clearError())},$scope.closeAlert=function(){$scope.error=""},$scope.loginUser=function(){$scope.error="",$scope.login?$scope.login.email?$scope.login.password?($scope.error="",logRegFactory.login($scope.login,function(output){output.data.error?$scope.error=output.data.error:(setCookie(output.data),window.location.replace("/#!/organization/"+$rootScope.loggedInUser.id))})):($scope.error="Password required to sign in",clearError()):($scope.error="Email required to sign in",clearError()):($scope.error="Please Enter in Email and Password",clearError())},$scope.adminLogin=function(isValid){$scope.error="",isValid?$scope.admin?$scope.admin.email?$scope.admin.password?(clearError(),$scope.error="",adminFactory.loginAdmin($scope.admin,function(output){output.data.error?($scope.error=output.data.error,clearError()):(setCookie(output.data,"admin"),window.location.replace("/#!/adminHome"))})):$scope.error="Password required to sign in":($scope.error="Email required to sign in",clearError()):($scope.error="Please Enter in Email and Password",clearError()):($scope.error="All fields are required",clearError())},$scope.myPage=function(){window.location.replace("/#!/organization/"+$rootScope.loggedInUser.id)},$scope.adminPage=function(){window.location.replace("/#!/adminHome")},$scope.logoutUser=function(){$cookies.remove("loggedUser"),$cookies.remove("loggedAdmin"),window.location.replace("/")},$scope.isNavCollapsed=!0,$scope.isCollapsed=!1,$scope.isCollapsedHorizontal=!1}]),app.controller("yourLocationCtrl",["$scope","$uibModalInstance","allFound","logRegFactory",function($scope,$uibModalInstance,allFound,logRegFactory){$scope.allFound=allFound,$scope.allFound.length>1?($scope.locationHeading="Please Select Your Address",$scope.locationButton="Select"):($scope.locationHeading="Is This Your Address?",$scope.locationButton="Yes"),$scope.selectedAddress=function(selectedInput){$uibModalInstance.close(selectedInput)},$scope.enterLatLong=function(){$uibModalInstance.close("LatLng")},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")}}]),app.controller("organizationCtrl",["$scope","$uibModalInstance","location","logRegFactory",function($scope,$uibModalInstance,location,logRegFactory){$scope.confirmPassword=function(isValid){isValid?($scope.reg2.address=location,logRegFactory.newRegistration($scope.reg2,function(output){if(output.data.error)$scope.error2=output.data.error;else{var response=output.data;$uibModalInstance.close(response)}})):($scope.error2="All fields are required",setTimeout(function(){$scope.$apply(function(){$scope.error2=!1})},5e3))},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.closeAlert=function(){$scope.error2=""}}]),app.controller("LatLngCtrl",["$scope","$uibModalInstance","logRegFactory","$window",function($scope,$uibModalInstance,logRegFactory,$window){$scope.latLngSubmit=function(isValid){isValid?logRegFactory.findLatLng($scope.latLng,function(output){output.data.error?($scope.error2=output.data.error,setTimeout(function(){$scope.$apply(function(){$scope.error2=""})},5e3)):$uibModalInstance.close(output.data[0])}):$scope.error2="Both Latitude and Longitude are required"},$scope.cancel=function(){$uibModalInstance.dismiss("cancel")},$scope.openGoogleMaps=function(){$window.open("http://www.maps.google.com","_blank")},$scope.closeAlert=function(){$scope.error2=""}}]),app.factory("adminFactory",["$http",function($http){var factory={};return factory.loginAdmin=function(input,callback){$http.post("/loginAdmin",input).then(function(output){callback(output)})},factory.getAllAdmin=function(callback){$http.post("/getAllAdmin").then(function(output){callback(output)})},factory.deleteOrg=function(input,callback){$http.post("/deleteOrgAdmin",input).then(function(output){callback(output)})},factory.editOrgAdmin=function(input,callback){$http.post("/editOrgAdmin",input).then(function(output){callback(output)})},factory}]),app.factory("editFactory",["$http",function($http){var factory={};return factory.getOrgInfo=function(input,callback){$http.post("/getOrgInfo",input).then(function(output){callback(output)})},factory.addDay=function(input,callback){$http.post("/addDay",input).then(function(output){callback(output)})},factory.removeDay=function(input,callback){$http.post("/removeDay",input).then(function(output){callback(output)})},factory.updateServices=function(input,callback){$http.post("/updateServices",input).then(function(output){callback(output)})},factory}]),app.factory("homeFactory",["$http",function($http){var factory={};return factory.findAllOrgs=function(callback){$http.post("/findAllOrgs").then(function(output){callback(output)})},factory.getNearBy=function(input,callback){$http.post("/getNearbyWeb",input).then(function(output){callback(output)})},factory.citySearch=function(input,callback){$http.post("/citySearch",input).then(function(output){callback(output)})},factory}]),app.factory("logRegFactory",["$http",function($http){var factory={};return factory.findLocation=function(input,callback){$http.post("/findLocation",input).then(function(output){callback(output)})},factory.findLatLng=function(input,callback){$http.post("/findLatLng",input).then(function(output){callback(output)})},factory.newRegistration=function(input,callback){$http.post("/newRegistration",input).then(function(output){callback(output)})},factory.login=function(input,callback){$http.post("/login",input).then(function(output){callback(output)})},factory}]);